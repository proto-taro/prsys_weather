<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>

const supabase = supabase.createClient(
  'https://kgrvnxtmfgbwpegexwqy.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtncnZueHRtZmdid3BlZ2V4d3F5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEyMzUyNTQsImV4cCI6MjA3NjgxMTI1NH0.ePwTBmz-6m4S0AkbE6kGwr68Bsh05CyaD_ZoYTQUfDY'
)

async function login(email, password) {
  const { data, error } = await supabase.auth.signInWithPassword({
    email,
    password
  })
  if (error) {
    alert('ログイン失敗: ' + error.message)
  } else {
    alert('ログイン成功！')
    showSurveyForm()
  }
}

async function submitSurvey(condition, comment) {
  const {
    data: { user }
  } = await supabase.auth.getUser()

  const { error } = await supabase.from('responses').insert([
    {
      user_id: user.id,
      email: user.email,
      condition: parseInt(condition),
      comment: comment,
      submitted_at: new Date().toISOString()
    }
  ])

  if (error) {
    alert('送信失敗: ' + error.message)
  } else {
    alert('送信完了！ありがとうございました')
  }
}

<!-- ログインフォーム -->
<form id="login-form">
  <input type="email" id="email" placeholder="メールアドレス" required />
  <input type="password" id="password" placeholder="パスワード" required />
  <button type="submit">ログイン</button>
</form>

<!-- アンケートフォーム（ログイン後に表示） -->
<form id="survey-form" style="display:none;">
  <select id="condition">
    <option value="3">☀️ 3</option>
    <option value="2">🌤️ 2</option>
    <option value="1">🌧️ 1</option>
  </select>
  <textarea id="comment" placeholder="備考（任意）"></textarea>
  <button type="submit">送信</button>
</form>

<script>
  document.getElementById('login-form').addEventListener('submit', (e) => {
    e.preventDefault()
    login(
      document.getElementById('email').value,
      document.getElementById('password').value
    )
  })

  function showSurveyForm() {
    document.getElementById('login-form').style.display = 'none'
    document.getElementById('survey-form').style.display = 'block'
  }

  document.getElementById('survey-form').addEventListener('submit', (e) => {
    e.preventDefault()
    submitSurvey(
      document.getElementById('condition').value,
      document.getElementById('comment').value
    )
  })
</script>
